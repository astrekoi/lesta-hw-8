# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Kubernetes + –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–í—ã–ø–æ–ª–Ω–∏–ª –ó–∏–Ω—á–µ–Ω–∫–æ –ê–Ω–¥—Ä–µ–π –≤ —Ä–∞–º–∫–∞—Ö –¥–æ–º–∞—à–Ω–µ–π —Ä–∞–±–æ—Ç—ã**

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–ü—Ä–æ–µ–∫—Ç –≤–∫–ª—é—á–∞–µ—Ç:
1. **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** –≤ Kubernetes —Å PostgreSQL
2. **–°–∏—Å—Ç–µ–º—É —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è** –Ω–∞ –æ—Å–Ω–æ–≤–µ Loki, Promtail –∏ Grafana
3. **Nginx reverse proxy** –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∏ Grafana

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
‚îú‚îÄ‚îÄ Dockerfile                    # Multi-stage —Å–±–æ—Ä–∫–∞ Go –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ Makefile                      # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ api/                          # Go –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ Swagger
‚îÇ   ‚îú‚îÄ‚îÄ cmd/demo/main.go
‚îÇ   ‚îú‚îÄ‚îÄ docs/                     # Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ go.mod, go.sum
‚îÇ   ‚îî‚îÄ‚îÄ internal/                 # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ       ‚îú‚îÄ‚îÄ api/                  # REST API handlers
‚îÇ       ‚îú‚îÄ‚îÄ config/               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ db/                   # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ       ‚îî‚îÄ‚îÄ logger/               # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ images/
‚îú‚îÄ‚îÄ k8s/                          # Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ configmap.yaml            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ deployment.yaml           # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ service.yaml              # –°–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ ingress.yaml              # Ingress Controller
‚îÇ   ‚îî‚îÄ‚îÄ logging/                  # –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ grafana.yaml          # Grafana –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
‚îÇ       ‚îú‚îÄ‚îÄ loki-config.yaml      # Loki –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤
‚îÇ       ‚îî‚îÄ‚îÄ promtail-config.yaml  # Promtail –¥–ª—è —Å–±–æ—Ä–∞ –ª–æ–≥–æ–≤
‚îî‚îÄ‚îÄ scripts/                      # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
    ‚îú‚îÄ‚îÄ cleanup.sh                # –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
    ‚îú‚îÄ‚îÄ deploy.sh                 # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
    ‚îú‚îÄ‚îÄ nginx-setup.sh            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx
    ‚îî‚îÄ‚îÄ setup.sh                  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
make setup
```
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Docker, Minikube, kubectl –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä.

### 2. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
make deploy
```
–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ—Ç Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å PostgreSQL –∏ —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
```bash
make nginx
```
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç nginx –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∏ Grafana –∏–∑–≤–Ω–µ.

## üåê –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã:

- **Go API:** `http://–í–ù–ï–®–ù–ò–ô_IP/ping`
- **Grafana:** `http://–í–ù–ï–®–ù–ò–ô_IP/grafana/` (admin/admin)
- **Swagger UI:** `http://–í–ù–ï–®–ù–ò–ô_IP/swagger/index.html`

## üìä –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **Loki:** –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ª–æ–≥–æ–≤
- **Promtail:** –°–±–æ—Ä –ª–æ–≥–æ–≤ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ Kubernetes
- **Grafana:** –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

### –†–∞–±–æ—Ç–∞ —Å –ª–æ–≥–∞–º–∏ –≤ Grafana

#### **–í–∞–∂–Ω–æ: —Å–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å Loki –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –≤ Grafana**

–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É –ª–æ–≥–æ–≤, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Grafana –¥–æ–±–∞–≤–ª–µ–Ω datasource Loki:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Grafana –ø–æ –∞–¥—Ä–µ—Å—É: `http:///grafana/`
2. –í–æ–π–¥–∏—Ç–µ —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é admin/admin)
3. –í –º–µ–Ω—é —Å–ª–µ–≤–∞ –≤—ã–±–µ—Ä–∏—Ç–µ **Configuration** (—à–µ—Å—Ç–µ—Ä–µ–Ω–∫–∞) ‚Üí **Data Sources**
4. –ù–∞–∂–º–∏—Ç–µ **Add data source** –∏ –≤—ã–±–µ—Ä–∏—Ç–µ **Loki**
5. –í –ø–æ–ª–µ **URL** –≤–≤–µ–¥–∏—Ç–µ: `http://loki:3100`
6. –ù–∞–∂–º–∏—Ç–µ **Save & Test**, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Ä–∞–±–æ—Ç–µ —Å –ª–æ–≥–∞–º–∏.

#### **–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:**

1. **–ü–µ—Ä–µ—Ö–æ–¥ –∫ –ª–æ–≥–∞–º:**
   - Grafana ‚Üí **Explore** ‚Üí –í—ã–±—Ä–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ **Loki**

2. **–û—Å–Ω–æ–≤–Ω—ã–µ LogQL –∑–∞–ø—Ä–æ—Å—ã:**
   ```logql
   # –í—Å–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   {app="lesta-app"}
   
   # –õ–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
   {app="lesta-app"}[5m]
   
   # HTTP –∑–∞–ø—Ä–æ—Å—ã
   {app="lesta-app"} |= "Incoming request"
   
   # –û—à–∏–±–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   {app="lesta-app"} |= "error"
   
   # SQL –∑–∞–ø—Ä–æ—Å—ã
   {app="lesta-app"} |= "SQL query executed"
   ```

3. **–°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞:**
   - Dashboards ‚Üí New ‚Üí Dashboard ‚Üí Add Panel
   - –í—ã–±–µ—Ä–∏—Ç–µ Loki –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### ConfigMap (k8s/configmap.yaml)
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:
```yaml
data:
  API_PORT: "8080"
  DB_URL: "postgres://USER_DB:PWD_DB@postgres:5432/DB"
  POSTGRES_DB: "DB"
  POSTGRES_USER: "USER_DB"
  POSTGRES_PASSWORD: "PWD_DB"
```

### Nginx Reverse Proxy
–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –æ–¥–∏–Ω –≤–Ω–µ—à–Ω–∏–π IP:
```nginx
# Grafana –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ /grafana/
location /grafana/ {
    proxy_pass http://MINIKUBE_IP:30300/;
}

# Go API –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∫–æ—Ä–Ω–µ–≤–æ–º—É –ø—É—Ç–∏
location / {
    proxy_pass http://MINIKUBE_IP:30080;
}
```

## üõ†Ô∏è Makefile –∫–æ–º–∞–Ω–¥—ã

```bash
make setup         # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
make deploy        # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
make nginx         # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx proxy
make cleanup       # –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
make help          # –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
curl http://–í–ù–ï–®–ù–ò–ô_IP/ping

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –ª–æ–≥–æ–≤
for i in {1..10}; do
  curl http://–í–ù–ï–®–ù–ò–ô_IP/ping
  curl http://–í–ù–ï–®–ù–ò–ô_IP/api/v1/roll_dice -X POST -d '{"sides":6}'
  sleep 1
done
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Kubernetes

### Deployments
- **lesta-app:** 2 —Ä–µ–ø–ª–∏–∫–∏ Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ—Ä—Ç 8080)
- **postgres:** 1 —Ä–µ–ø–ª–∏–∫–∞ PostgreSQL 16
- **grafana:** 1 —Ä–µ–ø–ª–∏–∫–∞ Grafana (–ø–æ—Ä—Ç 3000)
- **loki:** 1 —Ä–µ–ø–ª–∏–∫–∞ Loki (–ø–æ—Ä—Ç 3100)

### Services
- **lesta-service:** NodePort 30080 ‚Üí –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- **grafana:** NodePort 30300 ‚Üí Grafana
- **postgres:** ClusterIP ‚Üí –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ –ë–î
- **loki:** ClusterIP ‚Üí –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ Loki

### DaemonSet
- **promtail:** –°–±–æ—Ä –ª–æ–≥–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ –∫–ª–∞—Å—Ç–µ—Ä–∞

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- Promtail —Ä–∞–±–æ—Ç–∞–µ—Ç —Å RBAC –ø—Ä–∞–≤–∞–º–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Kubernetes API
- PostgreSQL –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
- Grafana –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ nginx proxy —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## üìù –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ë–µ–∑ hostNetwork:** Promtail –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–π DNS –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Loki
2. **JSON –ø–∞—Ä—Å–∏–Ω–≥:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Docker JSON –ª–æ–≥–æ–≤ –æ—Ç Kubernetes
3. **ConfigMap:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –±–µ–∑ Helm
4. **Nginx integration:** –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

## üßπ –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

```bash
make cleanup
```

–£–¥–∞–ª—è–µ—Ç –≤—Å–µ Kubernetes —Ä–µ—Å—É—Ä—Å—ã –∏ Docker –æ–±—Ä–∞–∑—ã.

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞:

![logs](/images/image.png)